import { Card, CardContent, Typography, Box, Divider } from '@mui/material';
import { useNavigate } from 'react-router-dom';
import React, { useRef, useState, useEffect } from 'react';
import BottomModal from '../../components/modal/BottomModal';
import Button from '../../components/button/Button';
import PwdModal6 from '../../components/modal/PwdModal6';
import AlertModal from '../../components/modal/AlertModal';
// import Keypad from '../../../components/Keypad';

import api from '../../utils/api'; // api Ïù∏ÌÑ∞ÏÖâÌÑ∞((Î™®Îì† ÏöîÏ≤≠Ïóê ÏûêÎèôÏúºÎ°ú ÌÜ†ÌÅ∞ Ï∂îÍ∞Ä))

// ÎÇ†ÏßúÌòïÏãù Î≥ÄÌôò YYYY-MM-DD
const formatDate = (date) => {
    if (date != null) return date.substring(0, 10);
};

// Í≥ÑÏ¢å Ï†ïÎ≥¥ ÌéòÏù¥ÏßÄ
const AccountInfoPage = () => {
    // Í∞ÄÏßú Îç∞Ïù¥ÌÑ∞ APIÏó∞Í≤∞ÌïòÍ≥† ÏÇ≠Ï†úÌï¥ÏïºÌï®
    const accountDTO = {
        accountNumber: '235-987-654321',
        createDate: '2025-02-01',
        endDate: '2025-03-02',
        balance: 360000,
        interestRate: 1.0,
        extraRate: 5.4,
        taxationYn: 'Y',
        dailyDeposit: 30000,
    };

    const navigate = useNavigate(); // useNavigate ÌõÖ ÏÇ¨Ïö©

    // üü¢ Î™®Îã¨ Ï∞∏Ï°∞Ïö© ref ÏÉùÏÑ±
    const paymentAmountInputModalRef = useRef(); // ÎÇ©ÏûÖÍ∏àÏï° ÏûÖÎ†• Î™®Îã¨ ref
    const pwdInputModalRef = useRef(); // ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• Î™®Îã¨ ref
    const completeModalRef = useRef(); // ÎÇ©ÏûÖÍ∏àÏï° Î≥ÄÍ≤Ω ÏôÑÎ£å Î™®Îã¨ ref
    const failAlertRef1 = useRef(); // ÎπÑÎ∞ÄÎ≤àÌò∏ Î∂àÏùºÏπò Î™®Îã¨ ref
    const failAlertRef2 = useRef(); // Ï†ÅÍ∏àÌï¥ÏßÄ Ïã§Ìå® Î™®Îã¨ ref

    const [data, setData] = useState({}); // API ÏÑ±Í≥µ Ïãú data Í∞í

    /* ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ START*/
    // ÎÇ©ÏûÖÍ∏àÏï° ÌÅ¥Î¶≠ Ïãú
    const handlePaymentAmountClick = () => {
        // ÏûÑÏãúÎ°ú Ïù¥ÏûêÏ°∞Ìöå ÌéòÏù¥ÏßÄ Ïù¥Îèô. Paymentaaaaa.jsÌéòÏù¥ÏßÄÎ•º Î™®Îã¨Î°ú Íµ¨ÌòÑÌï¥ÏïºÌï®
        navigate('/paymentaaaaa'); // Ïù¥Ïûê Ï°∞Ìöå ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
        // OpenPaymentAmountInputModal(); // ÎÇ©ÏûÖÍ∏àÏï° ÏûÖÎ†• Î™®Îã¨ open
        // alert(
        //     `ÎÇ©ÏûÖÍ∏àÏï° Î™®Îã¨ ÎùÑÏõåÏÑú ÏûÖÎ†•Î∞õÍ≥†, ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•Î™®Îã¨ ÎùÑÏõåÏÑú ÏûÖÎ†•Î∞õÍ≥† ÎÇ©ÏûÖÍ∏àÏï° Î≥ÄÍ≤Ω API Ìò∏Ï∂úÌï¥ÏïºÌï®`,
        // );
    };

    // Ïù¥ÏûêÏ°∞Ìöå ÌÅ¥Î¶≠ Ïãú
    const handleInterestClick = () => {
        navigate('/interestMainPage'); // Ïù¥Ïûê Ï°∞Ìöå ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
    };

    // Ìï¥ÏßÄ ÌÅ¥Î¶≠ Ïãú
    const handleTerminationClick = () => {
        navigate('/termination'); // Ï§ëÎèÑ Ìï¥ÏßÄ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
    };
    /* ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ END */

    /* Î™®Îã¨ Í¥ÄÎ¶¨ START */
    // ÎÇ©ÏûÖÍ∏àÏï° ÏûÖÎ†• Î™®Îã¨ open
    const OpenPaymentAmountInputModal = () => {
        if (paymentAmountInputModalRef.current) {
            paymentAmountInputModalRef.current.openModal();
        }
    };
    // ÎÇ©ÏûÖÍ∏àÏï° ÏûÖÎ†• Î™®Îã¨ close
    const ClosePaymentAmountInputModal = () => {
        if (paymentAmountInputModalRef.current) {
            paymentAmountInputModalRef.current.closeModal();
        }
    };
    // ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• Î™®Îã¨ open
    const OpenPwdInputModal = () => {
        if (pwdInputModalRef.current) {
            pwdInputModalRef.current.openModal();
        }
    };
    // ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• Î™®Îã¨ close
    const ClosePwdInputModal = () => {
        if (pwdInputModalRef.current) {
            pwdInputModalRef.current.closeModal();
        }
    };
    // ÎÇ©ÏûÖÍ∏àÏï° Î≥ÄÍ≤Ω ÏôÑÎ£å Î™®Îã¨ open
    const OpenCompleteModal = () => {
        if (completeModalRef.current) {
            completeModalRef.current.openModal();
        }
    };
    // ÎÇ©ÏûÖÍ∏àÏï° Î≥ÄÍ≤Ω ÏôÑÎ£å Î™®Îã¨ close
    const CloseCompleteModal = () => {
        if (completeModalRef.current) {
            completeModalRef.current.closeModal(); // Ìï¥ÏßÄ ÏôÑÎ£å Î™®Îã¨ Îã´Í≥†
            navigate('/manageAccount'); // Í≥ÑÏ¢åÍ¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÎ°ú Îã§ÏãúÏù¥Îèô
        }
    };

    // alertÎ™®Îã¨
    const OpenFailAlertRef1 = () => {
        if (failAlertRef1.current) {
            failAlertRef1.current.openModal();
        }
    };
    const CloseFailAlertRef1 = () => {
        if (failAlertRef1.current) {
            failAlertRef1.current.closeModal();
        }
    };
    const OpenFailAlertRef2 = () => {
        if (failAlertRef2.current) {
            failAlertRef2.current.openModal();
        }
    };
    const CloseFailAlertRef2 = () => {
        if (failAlertRef2.current) {
            failAlertRef2.current.closeModal();
        }
    };
    /* Î™®Îã¨Í¥ÄÎ¶¨ END */

    // Í∞ÑÌé∏ ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• ÌõÑ ÌîÑÎ°úÏÑ∏Ïä§
    const inputPwdProcess = async (pwd) => {
        //     ClosePwdInputModal();
        //     console.log('ÏûÖÎ†•Îêú pwdÍ∞í!!!!!!!!', pwd); // üî• ÌôïÏù∏Ïö© Î°úÍ∑∏
        //     const result = await termination(pwd); // ÎÇ©ÏûÖÍ∏àÏï° Î≥ÄÍ≤Ω API Ïã§ÌñâÌïòÍ≥† await Í≤∞Í≥º Í∏∞Îã§Î¶¨Í∏∞
        //     if (result === 1) {
        //         OpenCompleteModal(); // Ìï¥ÏßÄ ÏôÑÎ£å Î™®Îã¨ open
        //     } else if (result === 401) {
        //         ClosePwdInputModal();
        //         OpenFailAlertRef1();
        //     } else {
        //         // Í∏∞ÌÉÄ Ïò§Î•ò
        //         ClosePwdInputModal();
        //         OpenFailAlertRef2();
        //     }
    };

    // Í≥ÑÏ¢åÏ†ïÎ≥¥ Ï°∞Ìöå API Ìò∏Ï∂ú
    const accountInfoAPI = () => {
        api.get('/account/info')
            .then((response) => {
                const data = response.data; // APIÌò∏Ï∂ú ÏùëÎãµÍ∞í: accountDTO
                setData(data.accountDTO);
                console.log('‚úÖ accountInfoAPI ÏÑ±Í≥µ:', data); // üî• ÌôïÏù∏Ïö© Î°úÍ∑∏
            })
            .catch((error) => {
                console.error(error);
            });
    };

    // ÎÇ©ÏûÖÍ∏àÏï° Î≥ÄÍ≤Ω API Ìò∏Ï∂ú ->"accountPassword", "paymentAmount" ÎÑòÍ≤®ÏïºÌï®
    // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú pwdÍ∞í, ÎÇ©ÏûÖÍ∏àÏï°Í∞í ÎÑòÍ≤®Ï§òÏïºÌï®@@@@@@@@ ÏÑúÎ≤ÑÏóêÏÑú (@RequestBody AccountDTO accountDTO)Î°ú Î∞õÏùå
    const updatePaymentAmountAPI = async (pwd, paymentAmount) => {
        try {
            const response = await api.patch(`/account/update/paymentAmount`, {
                accountPassword: pwd, // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú Í∞ÑÌé∏ÎπÑÎ∞ÄÎ≤àÌò∏
                paymentAmount: paymentAmount, // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ÎÇ©ÏûÖÍ∏àÏï°
            });
            const result = response.data; // APIÌò∏Ï∂ú ÏùëÎãµÍ∞í (1:ÏÑ±Í≥µ, 0:Ïã§Ìå®, 401:ÎπÑÎ∞ÄÎ≤àÌò∏ Î∂àÏùºÏπò)
            console.log('‚úÖ updatePaymentAmountAPI ÏÑ±Í≥µ resultÍ∞íÏùÄ???:', result); // üî• ÌôïÏù∏Ïö© Î°úÍ∑∏
            return result;
        } catch (error) {
            console.error('‚ùå API ÏöîÏ≤≠ Ïã§Ìå®:', error);
            return 0; // Ïã§Ìå® Ïãú 0Î∞òÌôò
        }
    };

    useEffect(() => {
        accountInfoAPI(); // Ï≤´ Î†åÎçîÎßÅ Ïãú Í≥ÑÏ¢åÏ†ïÎ≥¥ Ï°∞Ìöå API Ìò∏Ï∂ú
    }, []);

    // ÎÇ†ÏßúÌòïÏãù Î≥ÄÌôò YYYY-MM-DD
    const formatDate = (date) => {
        if (date != null) return date.substring(0, 10);
    };

    /* ÌÇ§Ìå®Îìú Í¥ÄÎ†® Î™®Ïùå START */

    // // ÌÇ§Ìå®Îìú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ïà´Ïûê Ï∂îÍ∞Ä
    // const handleKeypadClick = (num) => {
    //     setAmount((prev) => (prev + num).slice(0, 5)); // ÏµúÎåÄ 5ÏûêÎ¶¨ÍπåÏßÄÎßå ÏûÖÎ†•
    // };

    // // ÏûÖÎ†• ÏßÄÏö∞Í∏∞
    // const handleDelete = () => {
    //     setAmount((prev) => prev.slice(0, -1));
    // };

    /* ÌÇ§Ìå®Îìú Í¥ÄÎ†® Î™®Ïùå END */
    return (
        <>
            <Box sx={{ padding: 0, marginTop: 3 }}>
                <Typography variant="h6" fontWeight="bold">
                    Î¶¨ÌîÑÏ†ÅÍ∏à
                </Typography>
                <Typography variant="body2" color="text.secondary">
                    {accountDTO.accountNumber}
                </Typography>
                <Card
                    variant="outlined"
                    sx={{ borderRadius: 3, margin: 1, padding: 0, marginBottom: 2 }}
                >
                    <CardContent>
                        <Box sx={{ padding: 2, backgroundColor: '#F7F7F7', borderRadius: 3 }}>
                            <Box
                                sx={{
                                    marginBottom: 1,
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                }}
                            >
                                <Typography variant="body2" color="text.secondary">
                                    Í∏∞Î≥∏ Í∏àÎ¶¨
                                </Typography>
                                <Typography variant="body2">
                                    {' '}
                                    {accountDTO?.interestRate} %
                                </Typography>
                            </Box>
                            <Box
                                sx={{
                                    marginBottom: 1,
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                }}
                            >
                                <Typography variant="body2" color="text.secondary">
                                    Í∞úÏÑ§Ïùº
                                </Typography>
                                <Typography variant="body2"> {accountDTO?.createDate}</Typography>
                            </Box>
                            <Box
                                sx={{
                                    marginBottom: 1,
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                }}
                            >
                                <Typography variant="body2" color="text.secondary">
                                    ÎßåÍ∏∞Ïùº
                                </Typography>
                                <Typography variant="body2"> {accountDTO?.endDate}</Typography>
                            </Box>
                            <Box
                                sx={{
                                    marginBottom: 1,
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                }}
                            >
                                <Typography variant="body2" color="text.secondary">
                                    ÏûîÏï°
                                </Typography>
                                <Typography variant="body2" sx={{ fontWeight: 'bold' }}>
                                    {`${accountDTO.balance.toLocaleString()}Ïõê`}
                                </Typography>
                            </Box>
                            <Box
                                sx={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    marginBottom: 1,
                                }}
                            >
                                <Typography variant="body2" color="text.secondary">
                                    Ï†ÅÏö©Í∏àÎ¶¨
                                </Typography>
                                <Box sx={{ textAlign: 'right' }}>
                                    <Typography variant="body2">
                                        Í∏∞Î≥∏Í∏àÎ¶¨ {accountDTO.interestRate}%
                                    </Typography>
                                    <Typography variant="body2">
                                        Ïö∞ÎåÄÍ∏àÎ¶¨ {accountDTO.extraRate}%
                                    </Typography>
                                </Box>
                            </Box>
                            <Box
                                sx={{
                                    marginBottom: 2,
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                }}
                            >
                                <Typography variant="body2" color="text.secondary">
                                    Í≥ºÏÑ∏Íµ¨Î∂Ñ
                                </Typography>
                                <Typography variant="body2">
                                    {accountDTO?.taxationYn == 'Y' ? 'ÏùºÎ∞òÍ≥ºÏÑ∏' : 'ÎπÑÍ≥ºÏÑ∏'}
                                </Typography>
                            </Box>
                        </Box>
                    </CardContent>
                </Card>
                {/* Í≥ÑÏ¢å ÏÑ§Ï†ï START */}
                <Typography variant="body1" color="text.secondary">
                    ÏÑ§Ï†ï
                </Typography>
                <Card variant="outlined" sx={{ borderRadius: 3, margin: 1, padding: 0 }}>
                    <CardContent>
                        <Box
                            sx={{
                                marginBottom: 0,
                                display: 'flex',
                                justifyContent: 'space-between',
                            }}
                        >
                            <Typography
                                variant="body2"
                                color="text.secondary"
                                onClick={handlePaymentAmountClick}
                            >
                                ÎÇ©ÏûÖÍ∏àÏï°
                            </Typography>
                            <Typography variant="body2" onClick={handlePaymentAmountClick}>
                                Îß§Ïùº 30,000Ïõê &gt;
                            </Typography>
                        </Box>
                        <Divider sx={{ marginY: 1, border: 1 }} />
                        <Box
                            sx={{
                                marginBottom: 0,
                                display: 'flex',
                                justifyContent: 'space-between',
                            }}
                        >
                            <Typography
                                variant="body2"
                                color="text.secondary"
                                onClick={handleInterestClick}
                            >
                                Ïù¥ÏûêÏ°∞Ìöå
                            </Typography>
                            <Typography variant="body2" onClick={handleInterestClick}>
                                &gt;
                            </Typography>
                        </Box>
                        <Divider sx={{ marginY: 1, border: 1 }} />
                        <Box
                            sx={{
                                marginBottom: 0,
                                display: 'flex',
                                justifyContent: 'space-between',
                            }}
                        >
                            <Typography
                                variant="body2"
                                color="text.secondary"
                                onClick={handleTerminationClick}
                            >
                                Ìï¥ÏßÄ
                            </Typography>
                            <Typography variant="body2" onClick={handleTerminationClick}>
                                &gt;
                            </Typography>
                        </Box>
                        <Divider sx={{ marginY: 1, border: 1 }} />
                    </CardContent>
                </Card>
                {/* Í≥ÑÏ¢å ÏÑ§Ï†ï END */}
            </Box>
            <>
                {/* Î™®Îã¨Î™®Ïùå */}

                {/* Í∞ÑÌé∏ ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• Î™®Îã¨ START */}
                <PwdModal6
                    ref={pwdInputModalRef}
                    onSubmit={(pwd) => {
                        // onSubmitÏóêÏÑú Îß§Í∞úÎ≥ÄÏàòÎ°ú ÏûÖÎ†•Îêú pwdÍ∞Ä ÎÑòÏñ¥Ïò¥
                        inputPwdProcess(pwd);
                    }}
                ></PwdModal6>
                {/* Í∞ÑÌé∏ ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• Î™®Îã¨ END */}
                {/* ÎÇ©ÏûÖÍ∏àÏï° Î≥ÄÍ≤Ω ÏôÑÎ£å Î™®Îã¨ START */}
                <BottomModal ref={completeModalRef}>
                    <Typography variant="h6" className="fw-bold m-4 ">
                        ÎÇ©ÏûÖ Í∏àÏï°Ïù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.
                    </Typography>
                    <Button
                        text="ÌôïÏù∏"
                        onClick={(e) => {
                            CloseCompleteModal();
                        }}
                    />
                </BottomModal>
                {/* ÎÇ©ÏûÖÍ∏àÏï° Î≥ÄÍ≤Ω ÏôÑÎ£å Î™®Îã¨ END */}
                {/* ÎπÑÎ∞ÄÎ≤àÌò∏ Î∂àÏùºÏπò Î™®Îã¨ START */}
                <AlertModal
                    ref={failAlertRef1}
                    text={'<span>ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.<br/>Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.</span>'}
                    onClick={CloseFailAlertRef1}
                />
                {/* ÎπÑÎ∞ÄÎ≤àÌò∏ Î∂àÏùºÏπò Î™®Îã¨ END */}
                {/* Ï†ÅÍ∏àÌï¥ÏßÄ Ïã§Ìå® Î™®Îã¨ START */}
                <AlertModal
                    ref={failAlertRef2}
                    text={'<span>Ï†ÅÍ∏àÌï¥ÏßÄ Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.<br/>Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.</span>'}
                    onClick={CloseFailAlertRef2}
                />
                {/* Ï†ÅÍ∏àÌï¥ÏßÄ Ïã§Ìå® Î™®Îã¨ END */}
            </>
        </>
    );
};

export default AccountInfoPage;
